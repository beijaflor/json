<!doctype html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>JSON to CSV</title>
<meta name="og:title" content="JSON to CSV" />

<meta name="description" content="A simple, in-browser JSON viewer, and CSV converter." />
<meta name="og:description" content="A simple, in-browser JSON viewer and CSV converter." />

<meta name="author" content="Eric Mill" />
<meta name="twitter:creator" content="@konklone" />
<meta name="twitter:url" content="http://konklone.io/json/" />

<link rel="shortcut icon" href="/json/favicon.png" />


<!-- jquery, jquery-csv,bootstrap -->
<script type='text/javascript' src='assets/jquery-2.1.1.min.js'></script>
<script src="assets/jquery.csv.js"></script>
<link href="assets/bootstrap.min.css" type="text/css" rel="stylesheet" />


<!-- site styles and JS -->
<link href="assets/site.css" type="text/css" rel="stylesheet" />
<link href="assets/github.css" type="text/css" rel="stylesheet" />
<script src="assets/site.js"></script>
<script src="assets/highlight.pack.js"></script>

<script>
  var excerptRows = 7;
  var input;
  var url;
  var lastSaved;

  function doJSON() {
    if (json) {
      // Reset any error message from previous failed parses.
      $("div.error").hide();
      $("div.warning").show();
    } else {
      $("div.warning").hide();
      $("div.error").show();
    }
    // Either way, update the error-reporting link to include the latest.
    setErrorReporting(null, input);
    return true;
  }

  function doCSV(json) {
    $("span.rows.count").text("" + outArray.length);

    // excerpt and render first 10 rows
    renderCSV(outArray.slice(0, excerptRows));

    // thanks to https://jsfiddle.net/terryyounghk/KPEGU/
    // and https://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side
    var uri = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
    $(".csv a.download").attr("href", uri);
  }

  function saveJSON() {
    // loads original pasted JSON from textarea, saves to anonymous gist
    // rate-limiting means this could easily fail with a 403.
    if (!input) return false;
    if (input == lastSaved) return false;

    // save a permalink to an anonymous gist
    var gist = {
      description: "test",
      public: false,
      files: {
        "source.json": {
            "content": input
        }
      }
    };

    // TODO: show spinner/msg while this happens

    console.log("Saving to an anonymous gist...");
    $.post(
      'https://api.github.com/gists',
      JSON.stringify(gist)
    ).done(function(data, status, xhr) {

      // take new Gist id, make permalink
      setPermalink(data.id);

      // send analytics event
      Events.permalink();

      // mark what we last saved
      lastSaved = input;

      // update error-reporting link, including permalink
      setErrorReporting(data.id, input);

      console.log("Remaining this hour: " + xhr.getResponseHeader("X-RateLimit-Remaining"));

    }).fail(function(xhr, status, errorThrown) {
      console.log(xhr);

      // send analytics event
      Events.permalink_error(status);

      // TODO: gracefully handle rate limit errors
      // if (status == 403)

      // TODO: show when saving will be available
      // e.g. "try again in 5 minutes"
      // var reset = xhr.getResponseHeader("X-RateLimit-Reset");
      // var date = new Date();
      // date.setTime(parseInt(reset) * 1000);
      // use http://momentjs.com/ to say "in _ minutes"

    });

    return false;
  }

  function setErrorReporting(id, content) {
    // Updates the error-reporting link to include current details.
    //
    // If the passed-in `id` is not null, a permalink is included.
    // If the passed-in `id` is null, then no permalink is included.
    // (Needed explicitly because the current URL doesn't always refer
    // to a permalink related to the current value of the textarea.)
    //
    // The current body of the textarea will be encoded into the URI,
    // to pre-populate the GitHub issue template, but only if the body
    // is < 7KB (7,168). GitHub's nginx server rejects query strings
    // longer than ~8KB.
    //
    // If no `id` is given, and content is too long, the URL will
    // encode only a title, and no body.
    var base = "https://github.com/konklone/json/issues/new";

    var title = "Error parsing some specific JSON";

    var body = "I'm having an issue converting this JSON:\n\n";
    if (id) body += (
      window.location.protocol + "//" +
      window.location.host + window.location.pathname +
      "?id=" + id + "\n\n"
    );

    if (content.length <= (7 * 1024))
      body += ("```json\n" + content + "\n```");

    var finalUrl = base + "?title=" + encodeURIComponent(title) +
      "&body=" + encodeURIComponent(body);

    $(".error a.report").attr("href", finalUrl);

    // console.log("Updated error reporting link to:" + finalUrl);
    return true;
  }

  function setPermalink(id) {
    // given a valid gist ID, set the permalink to use it
    if (history && history.pushState)
      history.pushState({id: id}, null, "?id=" + id);

    // log("Permalink created! (Copy from the location bar.)")
  }

  function loadPermalink() {
    // check query string for gist ID
    var id = getParam("id");
    if (!id) return;

    $.get('https://api.github.com/gists/' + id,
      function(data, status, xhr) {
        console.log("Remaining this hour: " + xhr.getResponseHeader("X-RateLimit-Remaining"));

        var input = data.files["source.json"].content;
        $(".json textarea").val(input);
        doJSON();
        showJSON(true);
      }
    ).fail(function(xhr, status, errorThrown) {
      console.log("Error fetching anonymous gist!");
      console.log(xhr);
      console.log(status);
      console.log(errorThrown);
    });
  }

  $(function() {

    $(".csv a.download").click(function() {
      // if there's no CSV to download, don't download anything.
      // also, log an analytics event.
      var data = $(".csv textarea").val();
      if (data) {
        Events.download(data.length);
        return true;
      } else
        return false;
    });

    // Both elements are present on page-load, so use normal click handler.
    $(".save a, .error a.save").click(saveJSON);

    // go away
    $("body").click(function() {
      $(".drop").hide();
    });

    // highlight CSV on click
    $(".csv textarea").click(function() {$(this).focus().select();});

    loadPermalink();
  });
</script>

</head>
<body>

<h1>Convert JSON to CSV</h1>

<div class="warning">
  Extremely large files may cause trouble &mdash; the conversion is done inside your browser.
</div>

<div class="error">
  There was an error parsing this JSON. If you're sure this JSON is valid, please
  <a class="report" target="_blank"
    href="https://github.com/konklone/json/issues/new">
    file an issue</a>.
  You can
  <a class="save" href="#">create a permalink to the error</a>
  any time.
</div>

<p>
  <span class="rendered">
    Below are the first few rows (<span class="rows count"></span> total).

    <a download="result.csv" href="#" class="download">
      Download the entire CSV</a>,

    or <a href="#" class="raw">show the raw data</a>.
  </span>

  <span class="editing">
    Your JSON will appear below as a table.
  </span>
</p>

<div id="react"></div>
<footer>
<p>
  Thanks to <a href="https://twitter.com/benbalter">@benbalter</a> for help, and to <a href="https://twitter.com/onyxfish">@onyxfish</a> for the amazing <a href="https://csvkit.readthedocs.org/en/latest/scripts/in2csv.html">csvkit</a>.
</p>
</footer>

<script>
  // (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  // (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  // m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  // })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  // ga('create', 'UA-252618-16', 'konklone.io');
  // ga('set', 'forceSSL', true);
  // ga('set', 'anonymizeIp', true);
  // ga('send', 'pageview');
</script>
<script src="build/js/bundle.js"></script>

</body>
</html>
